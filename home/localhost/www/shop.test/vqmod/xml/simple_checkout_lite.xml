<?xml version="1.0"?>
<modification>
  <id>Simple_Checkout_Lite</id>
  <version>1.0.0</version>
  <vqmver>2.3.2</vqmver>
  <author>tl.anhduc</author>
  
  ///////////////front-end///////////////////
    
    <file name="catalog/view/theme/*/template/checkout/cart.tpl">
       
		<operation>
		  <search position="before"><![CDATA[<?php echo $content_bottom; ?></div>]]></search>
		  <add><![CDATA[<div id="order-info" class="order-info" style="display:none;position:relative;top:50%;background:#fff;width: 980px;height:auto;margin-left: auto;margin-right: auto;text-align: left;">
				<h2><?php echo $text_order_info; ?></h2>
				<table class="register_form" style="border:1px solid #eee;padding:10px;margin-bottom:20px;width:100%;">
					<tbody>
						<tr>
							<td style="width:15%"><span class="required">*</span> <?php echo $text_customer_name; ?></td>
							<td><input type="text" name="name_order" class="text" style="width:400px" /></td>
						</tr>
						<tr>
							<td>&nbsp;&nbsp; <?php echo $text_customer_company; ?></td>
							<td><input type="text" name="company_order" class="text" style="width:400px" /></td>
						</tr>
						<tr>
							<td><span class="required">*</span> <?php echo $text_customer_phone; ?></td>
							<td><input type="text" name="phone_order" value="" class="text" style="width:400px" /></td>
						</tr>
						<tr>
							<td><span class="required">*</span> <?php echo $text_customer_address; ?></td>
							<td><input type="text" name="address_order" value="" class="text" style="width:400px" /></td>
						</tr>
						<tr>
							<td><span class="required">*</span> <?php echo $text_customer_email; ?></td>
							<td><input type="text" name="email_order" value="" class="text" style="width:400px" /></td>
						</tr>
						<tr>
							<td>&nbsp;&nbsp; <?php echo $text_customer_note; ?></td>
							<td><textarea name="note_order" style="width: 99%;" rows="5"></textarea></td>
						</tr>
					</tbody>
				</table>
				<div class="buttons">
					<div class="right"><a id="quick-checkout-confirm" class="button">Confirm checkout</a></div>
					<div class="center"><a id="quick-checkout-back" class="button">Cancel</a></div>
				  </div>
				</form>
				</div>]]></add>
		</operation>   
		
		<operation>
		  <search position="replace"><![CDATA[<div class="right"><a href="<?php echo $checkout; ?>" class="button"><?php echo $button_checkout; ?></a></div>]]></search>
		  <add><![CDATA[<div class="right"><a id="quick-checkout" class="button">Quick Checkout</a> &nbsp; - or - &nbsp; <a href="<?php echo $checkout; ?>" class="button"><?php echo $button_checkout; ?></a></div>]]></add>
		</operation>
		
		<operation>
		  <search position="after"><![CDATA[<?php echo $content_bottom; ?></div>]]></search>
		  <add><![CDATA[<script type="text/javascript"><!--
				$('#quick-checkout').live('click', function() {
					$('#order-info').slideDown();
				});
				$('#quick-checkout-back').live('click', function() {
					$('#order-info').slideUp();
					$('#error_name_order').remove();
					$('#error_phone_order').remove();
					$('#error_address_order').remove();
					$('#error_email_order').remove();
					$('#order-info input, #order-info textarea').val("");
				});
			//--></script>]]></add>
		</operation>
		
		<operation>
		  <search position="after"><![CDATA[<?php echo $content_bottom; ?></div>]]></search>
		  <add><![CDATA[<script type="text/javascript"><!--
				$('#quick-checkout-confirm').live('click', function() {
					var error_flag = true;
					if(($('input[name=\'name_order\']').val().length < 1) || ($('input[name=\'name_order\']').val().length > 32)) {
						$('#error_name_order').remove();
						error_flag = false;
						$('input[name=\'name_order\']').after('&nbsp; <span id="error_name_order" class="error" style="display:inline-block;"><?php echo $error_customer_name; ?></span>');
					}
					else
					{
						$('#error_name_order').remove();
					}
					
					var phoneReg = /^[0-9-+]+$/;
					if($('input[name=\'phone_order\']').val().length < 1 || !phoneReg.test($('input[name=\'phone_order\']').val())) {
						$('#error_phone_order').remove();
						error_flag = false;
						$('input[name=\'phone_order\']').after('&nbsp; <span id="error_phone_order" class="error" style="display:inline-block;"><?php echo $error_customer_phone; ?></span>');
					}
					else
					{
						$('#error_phone_order').remove();
					}
					if(($('input[name=\'address_order\']').val().length < 3) || ($('input[name=\'address_order\']').val().length > 128)) {
						$('#error_address_order').remove();
						error_flag = false;
						$('input[name=\'address_order\']').after('&nbsp; <span id="error_address_order" class="error" style="display:inline-block;"><?php echo $error_customer_address; ?></span>');
					}
					else
					{
						$('#error_address_order').remove();
					}
					
					var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
					if($('input[name=\'email_order\']').val().length < 1 || !emailReg.test($('input[name=\'email_order\']').val())) {
						$('#error_email_order').remove();
						error_flag = false;
						$('input[name=\'email_order\']').after('&nbsp; <span id="error_email_order" class="error" style="display:inline-block;"><?php echo $error_customer_email; ?></span>');
					}
					else
					{
						$('#error_email_order').remove();
					}
					
					
					if(error_flag == false) {
						return false;
					}
					$.ajax({
						url: 'index.php?route=checkout/cart/order',
						type: 'post',
						data: 'name_order=' + $('input[name=\'name_order\']').val() + '&company_order=' + $('input[name=\'company_order\']').val() + '&phone_order=' + $('input[name=\'phone_order\']').val() + '&address_order=' + $('input[name=\'address_order\']').val() + '&email_order=' + $('input[name=\'email_order\']').val() + '&note_order=' + $('textarea[name=\'note_order\']').val(),
						dataType: 'json',	
						beforeSend: function() {
							$('#quick-checkout-confirm').before('<span class="wait" ><img src="catalog/view/theme/default/image/loading.gif" alt="" />'+'  Processing...   </span>');
						},
						complete: function() {
							$('.wait').remove();
						},		
						
						success: function() {
							alert("<?php echo $text_alert_success; ?>");
							window.location='index.php?route=common/home';
							
						}
					});

				});
				//--></script> ]]></add>
		</operation>
	
    </file>
	
	<file name="catalog/language/english/checkout/cart.php">
		<operation>
		  <search position="after"><![CDATA[$_['text_empty']             = 'Your shopping cart is empty!';]]></search>
		  <add><![CDATA[$_['text_order_info']        = 'Customer Infomation';
						$_['text_customer_name']     = 'Name:';
						$_['text_customer_company']  = 'Company:';
						$_['text_customer_phone']    = 'Phone:';
						$_['text_customer_address']  = 'Address:';
						$_['text_customer_email']    = 'E-Mail:';
						$_['text_customer_note']     = 'Descriptions:';
						$_['text_alert_success']     = 'Your order has been successfully processed! Please direct any questions you have to the store owner. Thanks for shopping with us online!';
				]]></add>
		</operation>
		<operation>
		  <search position="after"><![CDATA[$_['error_no_shipping']      = 'Warning: No Shipping options are available. Please <a href="%s">contact us</a> for assistance!';]]></search>
		  <add><![CDATA[
						$_['error_customer_name']    = 'Name must be between 1 and 32 characters!';
						$_['error_customer_phone']   = 'Telephone does not appear to be valid!';
						$_['error_customer_address'] = 'Address must be between 3 and 128 characters!';
						$_['error_customer_email']   = 'E-Mail Address does not appear to be valid!';
				]]></add>
		</operation>
	</file>
	
    <file name="catalog/controller/checkout/cart.php">
		<operation>
		  <search position="replace"><![CDATA[$this->data['action'] = $this->url->link('checkout/cart'); ]]></search>
		  <add><![CDATA[$this->data['action'] = ""; ]]></add>
		</operation>
		<operation>
		  <search position="after"><![CDATA[$this->data['text_none'] = $this->language->get('text_none');]]></search>
		  <add><![CDATA[$this->data['text_order_info'] = $this->language->get('text_order_info');
			$this->data['text_customer_name'] = $this->language->get('text_customer_name');
			$this->data['text_customer_company'] = $this->language->get('text_customer_company');
			$this->data['text_customer_phone'] = $this->language->get('text_customer_phone');
			$this->data['text_customer_address'] = $this->language->get('text_customer_address');
			$this->data['text_customer_email'] = $this->language->get('text_customer_email');
			$this->data['text_customer_note'] = $this->language->get('text_customer_note');
			$this->data['text_alert_success'] = $this->language->get('text_alert_success');
			$this->data['error_customer_name'] = $this->language->get('error_customer_name');
			$this->data['error_customer_phone'] = $this->language->get('error_customer_phone');
			$this->data['error_customer_address'] = $this->language->get('error_customer_address');
			$this->data['error_customer_email'] = $this->language->get('error_customer_email');]]></add>
		</operation>
		<operation>
		  <search position="before"><![CDATA[public function add() {]]></search>
		  <add><![CDATA[public function order() {
				$this->language->load('checkout/cart');
				$message = "<h2>" . $this->language->get('text_order_info') . "</h2>
				<table class='customer_info'>
				<tr>
					<td style='padding: 5px 0;'><b>" . $this->language->get('text_customer_name') . "</b></td>
					<td>" . $this->request->post['name_order'] . "</td>
				</tr>
				<tr>
					<td style='padding: 5px 0;'><b>" . $this->language->get('text_customer_company') . "</b></td>
					<td>" . $this->request->post['company_order'] . "</td>
				</tr>
				<tr>
					<td style='padding: 5px 0;'><b>" . $this->language->get('text_customer_phone') . "</b></td>
					<td>" . $this->request->post['phone_order'] . "</td>
				</tr>
				<tr>
					<td style='padding: 5px 0;'><b>" . $this->language->get('text_customer_address') . "</b></td>
					<td>" . $this->request->post['address_order'] . "</td>
				</tr>
				<tr>
					<td style='padding: 5px 0;'><b>" . $this->language->get('text_customer_email') . "</b></td>
					<td>" . $this->request->post['email_order'] . "</td>
				</tr>
				<tr>
					<td style='padding: 5px 0;'><b>" . $this->language->get('text_customer_note') . "</b></td>
					<td>" . $this->request->post['note_order'] . "</td>
				</tr>
				</table><br>
				<table class='cart_info' width='100%' style='border-collapse: collapse;border-top: 1px solid #0e9fba;border-left: 1px solid #0e9fba;border-right: 1px solid #0e9fba;'>
						<thead style='background:#0e9fba;color:#fff;' align='center'>
						  <tr>
							<td style='padding: 7px;'>" . $this->language->get('column_name') . "</td>
							<td>" . $this->language->get('column_model') . "</td>
							<td>" . $this->language->get('column_quantity') . "</td>
							<td>" . $this->language->get('column_price') . "</td>
							<td>" . $this->language->get('column_total') . "</td>
						  </tr>
						</thead>
						<tbody>
							" ; 
						
						foreach ($this->cart->getProducts() as $product_order) {
							//get URL product
							$url_product = $this->url->link('product/product', 'product_id=' . $product_order['product_id']);
														
							//get unit product
								$tablewunit = $this->db->query("SELECT wcd.unit FROM " . DB_PREFIX . "weight_class_description wcd WHERE (wcd.weight_class_id = " . $product_order['weight_class_id'] . ") AND wcd.language_id = '" . (int)$this->config->get('config_language_id') . "'");
								$weight_order = $tablewunit->row['unit'];
							
							// Display prices
								if (($this->config->get('config_customer_price') && $this->customer->isLogged()) || !$this->config->get('config_customer_price')) {
									$price_order = $this->currency->format($this->tax->calculate($product_order['price'], $product_order['tax_class_id'], $this->config->get('config_tax')));
								} else {
									$price_order = false;
								}
								
							// Display total
								if (($this->config->get('config_customer_price') && $this->customer->isLogged()) || !$this->config->get('config_customer_price')) {
									$total_order = $this->currency->format($this->tax->calculate($product_order['price'], $product_order['tax_class_id'], $this->config->get('config_tax')) * $product_order['quantity']);
								} else {
									$total_order = false;
								}
								
							$message .= "
							  <tr align='center' style='border-bottom: 1px solid #0e9fba;'>
								<td style='padding: 7px;'><a href='" . $url_product . "' >" . $product_order['name'] . "</a></td>
								<td>" . $product_order['model'] . "</td>
								<td>" . $product_order['quantity'] . "</td>
								<td>" . $price_order . "</td>
								<td>" . $total_order . "</td>
							  </tr> ";
						}
						$message .= "</tbody>
				</table><br>
				<table style='float:right;'>
					<tbody> ";
					    //get total cart
						foreach ($this->getTotalOrder() as $total_order) {	
						  $message .= "
							<tr>
								<td style='text-align:right;'><b>" . $total_order['title'] . ": &nbsp; </b></td>
								<td style='text-align:right;'>" . $total_order['text'] . "</td>
							</tr> ";
						}
						  $message .= "</tbody>
				</table> ";

				$email_cc = $this->request->post['email_order'] ;
				$email_to = array($this->config->get('config_email'),$email_cc);
				
				$emails = explode(',', $this->config->get('config_alert_emails'));
				foreach ($emails as $email_alert) {
					array_push($email_to,$email_alert);
				}
				
				$email_subject = $this->config->get('config_name') ." - Orders Information";
				$mail = new Mail();

				$mail->protocol = $this->config->get('config_mail_protocol');
				$mail->parameter = $this->config->get('config_mail_parameter');
				$mail->hostname = $this->config->get('config_smtp_host');
				$mail->username = $this->config->get('config_smtp_username');
				$mail->password = $this->config->get('config_smtp_password');
				$mail->port = $this->config->get('config_smtp_port');
				$mail->timeout = $this->config->get('config_smtp_timeout');            
				$mail->setTo($email_to);
				$mail->setFrom($mail->username);
				$mail->setSender($mail->username);
				$mail->setSubject($email_subject);
				$mail->setHtml($message);

				$mail->send();
				session_destroy();
			}
			
			private function getTotalOrder() {
			// Totals
				$this->load->model('setting/extension');
				
				$total_data = array();					
				$total = 0;
				$taxes = $this->cart->getTaxes();
				
				// Display prices
				if (($this->config->get('config_customer_price') && $this->customer->isLogged()) || !$this->config->get('config_customer_price')) {
					$sort_order = array(); 
					
					$results = $this->model_setting_extension->getExtensions('total');
					
					foreach ($results as $key => $value) {
						$sort_order[$key] = $this->config->get($value['code'] . '_sort_order');
					}
					
					array_multisort($sort_order, SORT_ASC, $results);
					
					foreach ($results as $result) {
						if ($this->config->get($result['code'] . '_status')) {
							$this->load->model('total/' . $result['code']);
				
							$this->{'model_total_' . $result['code']}->getTotal($total_data, $total, $taxes);
						}
						
						$sort_order = array(); 
					  
						foreach ($total_data as $key => $value) {
							$sort_order[$key] = $value['sort_order'];
						}
			
						array_multisort($sort_order, SORT_ASC, $total_data);			
					}
				}
				return 	$total_data;
			}
			]]></add>
		</operation>
	</file>
	
</modification>
